

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>audonnx.core.model &mdash; Documentation</title>
  

  
  
    <link rel="shortcut icon" href="../../../_static/favicon.png"/>
  
  
  

  

  
  
    

  
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/css/audeering.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/jupyter-sphinx.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/thebelab.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/copybutton.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    
  

  
  <script src="../../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          <a href="../../../index.html">
          
            <img src="../../../_static/images/audeering.png" class="logo" alt="audEERING"/>
          
          
            <span> audonnx</span>
          
          </a>

          
            
            
              <div class="version">
                v1.0.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption" role="heading"><span class="caption-text">Getting started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../usage.html">Usage</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../api/audonnx.html">audonnx</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/audonnx.testing.html">audonnx.testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../genindex.html">Index</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Development</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../contributing.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../changelog.html">Changelog</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">audonnx</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../../index.html">Module code</a> &raquo;</li>
      <li>audonnx.core.model</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for audonnx.core.model</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span><span class="w"> </span><span class="nn">collections.abc</span><span class="w"> </span><span class="kn">import</span> <span class="n">Sequence</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">onnx</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">onnxruntime</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">yaml</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">audeer</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">audobject</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">audonnx.core.node</span><span class="w"> </span><span class="kn">import</span> <span class="n">InputNode</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">audonnx.core.node</span><span class="w"> </span><span class="kn">import</span> <span class="n">OutputNode</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">audonnx.core.ort</span><span class="w"> </span><span class="kn">import</span> <span class="n">device_to_providers</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">audonnx.core.typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Device</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">audonnx.core.typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Labels</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">audonnx.core.typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Transform</span>


<div class="viewcode-block" id="Model"><a class="viewcode-back" href="../../../api/audonnx.Model.html#audonnx.Model">[docs]</a><span class="k">class</span><span class="w"> </span><span class="nc">Model</span><span class="p">(</span><span class="n">audobject</span><span class="o">.</span><span class="n">Object</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Model with multiple input and output nodes.</span>

<span class="sd">    For input nodes an optional transform can be given</span>
<span class="sd">    that transforms the input into the desired representation,</span>
<span class="sd">    otherwise the raw input is used.</span>
<span class="sd">    Use dictionary to assign transform objects to specific nodes</span>
<span class="sd">    if model has multiple input nodes.</span>

<span class="sd">    For output nodes an optional list of labels can be given</span>
<span class="sd">    to assign names to the last non-dynamic dimension.</span>
<span class="sd">    E.g. if the shape of the output node is</span>
<span class="sd">    ``(1, 3, -1)``</span>
<span class="sd">    three labels can be assigned to the second dimension.</span>
<span class="sd">    By default,</span>
<span class="sd">    labels are generated from the name of the node.</span>
<span class="sd">    Use dictionary to assign labels to specific nodes</span>
<span class="sd">    if model has multiple output nodes.</span>

<span class="sd">    :class:`Model` inherites from :class:`audobject.Object`,</span>
<span class="sd">    which means you can serialize to</span>
<span class="sd">    and instantiate the class</span>
<span class="sd">    from a YAML file.</span>
<span class="sd">    Have a look at :class:`audobject.Object`</span>
<span class="sd">    to see all available methods.</span>

<span class="sd">    Args:</span>
<span class="sd">        path: ONNX proto object or path to ONNX file</span>
<span class="sd">        labels: list of labels or dictionary with labels</span>
<span class="sd">        transform: callable object or a dictionary of callable objects</span>
<span class="sd">        device: set device</span>
<span class="sd">            (``&#39;cpu&#39;``, ``&#39;cuda&#39;``, or ``&#39;cuda:&lt;id&gt;&#39;``)</span>
<span class="sd">            or a (list of) `provider(s)`_</span>
<span class="sd">        num_workers: number of threads for running</span>
<span class="sd">            onnxruntime inference on cpu.</span>
<span class="sd">            If ``None`` and ``session_options`` is ``None``,</span>
<span class="sd">            onnxruntime chooses the number of threads</span>
<span class="sd">        session_options: :class:`onnxruntime.SessionOptions`</span>
<span class="sd">            to use for inference.</span>
<span class="sd">            If ``None`` the default options are used</span>
<span class="sd">            and the number of threads</span>
<span class="sd">            for running inference on cpu</span>
<span class="sd">            is determined by ``num_workers``.</span>
<span class="sd">            Otherwise,</span>
<span class="sd">            the provided options are used</span>
<span class="sd">            and the ``session_options`` properties</span>
<span class="sd">            :attr:`~onnxruntime.SessionOptions.inter_op_num_threads`</span>
<span class="sd">            and :attr:`~onnxruntime.SessionOptions.intra_op_num_threads`</span>
<span class="sd">            determine the number of threads</span>
<span class="sd">            for inference on cpu</span>
<span class="sd">            and ``num_workers`` is ignored</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; import audiofile</span>
<span class="sd">        &gt;&gt;&gt; import opensmile</span>
<span class="sd">        &gt;&gt;&gt; transform = opensmile.Smile(</span>
<span class="sd">        ...     opensmile.FeatureSet.GeMAPSv01b,</span>
<span class="sd">        ...     opensmile.FeatureLevel.LowLevelDescriptors,</span>
<span class="sd">        ... )</span>
<span class="sd">        &gt;&gt;&gt; path = os.path.join(&quot;tests&quot;, &quot;model.onnx&quot;)</span>
<span class="sd">        &gt;&gt;&gt; model = Model(</span>
<span class="sd">        ...     path,</span>
<span class="sd">        ...     labels=[&quot;female&quot;, &quot;male&quot;],</span>
<span class="sd">        ...     transform=transform,</span>
<span class="sd">        ... )</span>
<span class="sd">        &gt;&gt;&gt; model</span>
<span class="sd">        Input:</span>
<span class="sd">          feature:</span>
<span class="sd">            shape: [18, -1]</span>
<span class="sd">            dtype: tensor(float)</span>
<span class="sd">            transform: opensmile.core.smile.Smile</span>
<span class="sd">        Output:</span>
<span class="sd">          gender:</span>
<span class="sd">            shape: [2]</span>
<span class="sd">            dtype: tensor(float)</span>
<span class="sd">            labels: [female, male]</span>
<span class="sd">        &gt;&gt;&gt; path = os.path.join(&quot;tests&quot;, &quot;test.wav&quot;)</span>
<span class="sd">        &gt;&gt;&gt; signal, sampling_rate = audiofile.read(path)</span>
<span class="sd">        &gt;&gt;&gt; model(</span>
<span class="sd">        ...     signal,</span>
<span class="sd">        ...     sampling_rate,</span>
<span class="sd">        ...     outputs=&quot;gender&quot;,</span>
<span class="sd">        ... ).round(1)</span>
<span class="sd">        array([-195.1,   73.3], dtype=float32)</span>

<span class="sd">    .. _`provider(s)`: https://onnxruntime.ai/docs/execution-providers/</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@audobject</span><span class="o">.</span><span class="n">init_decorator</span><span class="p">(</span>
        <span class="n">borrow</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;labels&quot;</span><span class="p">:</span> <span class="s2">&quot;_original_args&quot;</span><span class="p">,</span>
            <span class="s2">&quot;transform&quot;</span><span class="p">:</span> <span class="s2">&quot;_original_args&quot;</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="n">resolvers</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="n">audobject</span><span class="o">.</span><span class="n">resolver</span><span class="o">.</span><span class="n">FilePath</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="n">hide</span><span class="o">=</span><span class="p">[</span>
            <span class="s2">&quot;device&quot;</span><span class="p">,</span>
            <span class="s2">&quot;num_workers&quot;</span><span class="p">,</span>
            <span class="s2">&quot;session_options&quot;</span><span class="p">,</span>
        <span class="p">],</span>
    <span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">onnx</span><span class="o">.</span><span class="n">ModelProto</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">labels</span><span class="p">:</span> <span class="n">Labels</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">transform</span><span class="p">:</span> <span class="n">Transform</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">device</span><span class="p">:</span> <span class="n">Device</span> <span class="o">=</span> <span class="s2">&quot;cpu&quot;</span><span class="p">,</span>
        <span class="n">num_workers</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">session_options</span><span class="p">:</span> <span class="p">(</span><span class="n">onnxruntime</span><span class="o">.</span><span class="n">SessionOptions</span> <span class="o">|</span> <span class="kc">None</span><span class="p">)</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="c1"># keep original arguments to store them</span>
        <span class="c1"># when object is serialized</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_original_args</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;labels&quot;</span><span class="p">:</span> <span class="n">labels</span><span class="p">,</span>
            <span class="s2">&quot;transform&quot;</span><span class="p">:</span> <span class="n">transform</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">audeer</span><span class="o">.</span><span class="n">path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Model path&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">session_options</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">session_options</span> <span class="o">=</span> <span class="n">onnxruntime</span><span class="o">.</span><span class="n">SessionOptions</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">num_workers</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">session_options</span><span class="o">.</span><span class="n">inter_op_num_threads</span> <span class="o">=</span> <span class="n">num_workers</span>
                <span class="n">session_options</span><span class="o">.</span><span class="n">intra_op_num_threads</span> <span class="o">=</span> <span class="n">num_workers</span>

        <span class="n">providers</span> <span class="o">=</span> <span class="n">device_to_providers</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sess</span> <span class="o">=</span> <span class="n">onnxruntime</span><span class="o">.</span><span class="n">InferenceSession</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">path</span><span class="o">.</span><span class="n">SerializeToString</span><span class="p">(),</span>
            <span class="n">sess_options</span><span class="o">=</span><span class="n">session_options</span><span class="p">,</span>
            <span class="n">providers</span><span class="o">=</span><span class="n">providers</span><span class="p">,</span>
        <span class="p">)</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Interference session&quot;&quot;&quot;</span>

        <span class="n">inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sess</span><span class="o">.</span><span class="n">get_inputs</span><span class="p">()</span>
        <span class="n">outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sess</span><span class="o">.</span><span class="n">get_outputs</span><span class="p">()</span>

        <span class="n">transform</span> <span class="o">=</span> <span class="n">transform</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">transform</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="nb">input</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="nb">input</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">]</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Model has multiple input nodes. &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;Please use a dictionary to assign &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;transform object to one of &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">names</span><span class="si">}</span><span class="s2">.&quot;</span>
                <span class="p">)</span>
            <span class="n">transform</span> <span class="o">=</span> <span class="p">{</span><span class="n">inputs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">transform</span><span class="p">}</span>

        <span class="n">labels</span> <span class="o">=</span> <span class="n">labels</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">outputs</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="n">output</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">output</span> <span class="ow">in</span> <span class="n">outputs</span><span class="p">]</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Model has multiple output nodes. &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;Please use a dictionary to assign &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;labels to one of &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">names</span><span class="si">}</span><span class="s2">.&quot;</span>
                <span class="p">)</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="p">{</span><span class="n">outputs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">labels</span><span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span> <span class="o">=</span> <span class="p">{}</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Input nodes&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="nb">input</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">:</span>
            <span class="n">trans</span> <span class="o">=</span> <span class="n">transform</span><span class="p">[</span><span class="nb">input</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="k">if</span> <span class="nb">input</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">transform</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="n">shape</span> <span class="o">=</span> <span class="n">_shape</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">name</span><span class="p">)]</span> <span class="o">=</span> <span class="n">InputNode</span><span class="p">(</span>
                <span class="n">shape</span><span class="p">,</span>
                <span class="nb">input</span><span class="o">.</span><span class="n">type</span><span class="p">,</span>
                <span class="n">trans</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span> <span class="o">=</span> <span class="p">{}</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Output nodes&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">output</span> <span class="ow">in</span> <span class="n">outputs</span><span class="p">:</span>
            <span class="n">shape</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">shape</span> <span class="ow">or</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">shape</span> <span class="o">=</span> <span class="n">_shape</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
            <span class="n">dim_size</span> <span class="o">=</span> <span class="n">_last_static_dim_size</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">output</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">:</span>
                <span class="n">lab</span> <span class="o">=</span> <span class="n">labels</span><span class="p">[</span><span class="n">output</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lab</span><span class="p">)</span> <span class="o">!=</span> <span class="n">dim_size</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Cannot assign &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">lab</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;labels to output node &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">output</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;when last non-dynamic dimension has size &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dim_size</span><span class="si">}</span><span class="s2">.&quot;</span>
                    <span class="p">)</span>
            <span class="k">elif</span> <span class="n">dim_size</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">lab</span> <span class="o">=</span> <span class="p">[</span><span class="n">output</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lab</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">output</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dim_size</span><span class="p">)]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="n">output</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">OutputNode</span><span class="p">(</span>
                <span class="n">shape</span><span class="p">,</span>
                <span class="n">output</span><span class="o">.</span><span class="n">type</span><span class="p">,</span>
                <span class="n">lab</span><span class="p">,</span>
            <span class="p">)</span>

<div class="viewcode-block" id="Model.__call__"><a class="viewcode-back" href="../../../api/audonnx.Model.html#audonnx.Model.__call__">[docs]</a>    <span class="nd">@audeer</span><span class="o">.</span><span class="n">deprecated_keyword_argument</span><span class="p">(</span>
        <span class="n">deprecated_argument</span><span class="o">=</span><span class="s2">&quot;output_names&quot;</span><span class="p">,</span>
        <span class="n">removal_version</span><span class="o">=</span><span class="s2">&quot;1.2.0&quot;</span><span class="p">,</span>
        <span class="n">new_argument</span><span class="o">=</span><span class="s2">&quot;outputs&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">inputs</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">|</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">object</span><span class="p">],</span>
        <span class="n">sampling_rate</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">outputs</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">concat</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">squeeze</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">|</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Compute output for one or more nodes.</span>

<span class="sd">        If ``inputs`` is a :class:`numpy.ndarray`,</span>
<span class="sd">        it is treated as the input signal.</span>

<span class="sd">        If ``inputs`` is a dictionary,</span>
<span class="sd">        the dictionary entries</span>
<span class="sd">        correspond to the input names and input values,</span>
<span class="sd">        and the argument names and values</span>
<span class="sd">        for input transformation.</span>

<span class="sd">        If ``outputs`` is a plain string,</span>
<span class="sd">        the output of the according node is returned.</span>

<span class="sd">        If ``outputs`` is a list of strings,</span>
<span class="sd">        a dictionary with according nodes as keys and</span>
<span class="sd">        their outputs as values is returned.</span>

<span class="sd">        If ``outputs`` is not set</span>
<span class="sd">        and the model has a single output node,</span>
<span class="sd">        the output of that node is returned.</span>
<span class="sd">        Otherwise a dictionary with outputs of all nodes is returned.</span>

<span class="sd">        If ``concat`` is set to ``True``,</span>
<span class="sd">        the output of the requested nodes is concatenated</span>
<span class="sd">        along the last non-dynamic axis</span>
<span class="sd">        and a single array is returned.</span>
<span class="sd">        This requires that the number of dimensions,</span>
<span class="sd">        the position of dynamic axis,</span>
<span class="sd">        and all dimensions except the last non-dynamic axis</span>
<span class="sd">        match for the requested nodes</span>

<span class="sd">        Use :attr:`audonnx.Model.outputs` to get a list of available</span>
<span class="sd">        output nodes.</span>

<span class="sd">        Args:</span>
<span class="sd">            inputs: model input signal</span>
<span class="sd">                or dictionary with multiple inputs</span>
<span class="sd">            sampling_rate: sampling rate in Hz</span>
<span class="sd">            outputs: name of output or list with output names</span>
<span class="sd">            concat: if ``True``,</span>
<span class="sd">                concatenate output of the requested nodes</span>
<span class="sd">            squeeze: if ``True``,</span>
<span class="sd">                remove axes of length one from the output(s)</span>

<span class="sd">        Returns:</span>
<span class="sd">            model output</span>

<span class="sd">        Raises:</span>
<span class="sd">            RuntimeError: if ``concat`` is ``True``,</span>
<span class="sd">                but output of requested nodes cannot be concatenated</span>
<span class="sd">            ValueError: if a required model input is missing</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">outputs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">outputs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">outputs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">outputs</span> <span class="o">=</span> <span class="n">outputs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">y</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">input_node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">input_node</span><span class="o">.</span><span class="n">transform</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">input_node</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">sampling_rate</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;The input </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> is missing from the input dictionary&quot;</span>
                    <span class="p">)</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">inputs</span>
            <span class="n">y</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

        <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">audeer</span><span class="o">.</span><span class="n">to_list</span><span class="p">(</span><span class="n">outputs</span><span class="p">),</span> <span class="n">y</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">z</span> <span class="o">=</span> <span class="n">z</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">z</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">values</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">values</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">z</span><span class="p">)}</span>
            <span class="k">if</span> <span class="n">concat</span><span class="p">:</span>
                <span class="n">shapes</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="n">node</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">outputs</span><span class="p">]</span>
                <span class="n">z</span> <span class="o">=</span> <span class="n">_concat</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">shapes</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">squeeze</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">z</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">values</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">values</span> <span class="ow">in</span> <span class="n">z</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">z</span> <span class="o">=</span> <span class="n">z</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">z</span></div>

    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Printable representation of model.&quot;&quot;&quot;</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;Input&quot;</span><span class="p">:</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">node</span><span class="o">.</span><span class="n">_dict</span><span class="p">()</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">items</span><span class="p">()},</span>
            <span class="s2">&quot;Output&quot;</span><span class="p">:</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">node</span><span class="o">.</span><span class="n">_dict</span><span class="p">()</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">items</span><span class="p">()},</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">default_flow_style</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;String representation of model.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

<div class="viewcode-block" id="Model.labels"><a class="viewcode-back" href="../../../api/audonnx.Model.html#audonnx.Model.labels">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">labels</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">outputs</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Collect labels of output nodes.</span>

<span class="sd">        Args:</span>
<span class="sd">            outputs: name of output or list with output names.</span>
<span class="sd">                Selects all output nodes by default</span>

<span class="sd">        Returns:</span>
<span class="sd">            list with labels</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">outputs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">outputs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">)</span>
        <span class="n">outputs</span> <span class="o">=</span> <span class="n">audeer</span><span class="o">.</span><span class="n">to_list</span><span class="p">(</span><span class="n">outputs</span><span class="p">)</span>

        <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">labels</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">outputs</span><span class="p">]</span>
        <span class="n">names</span> <span class="o">=</span> <span class="n">audeer</span><span class="o">.</span><span class="n">flatten_list</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">names</span></div>

<div class="viewcode-block" id="Model.to_yaml"><a class="viewcode-back" href="../../../api/audonnx.Model.html#audonnx.Model.to_yaml">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">to_yaml</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">include_version</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Save model to YAML file.</span>

<span class="sd">        If ONNX model was loaded from a byte stream,</span>
<span class="sd">        it will be saved in addition to the YAML file</span>
<span class="sd">        under the same path</span>
<span class="sd">        with file extension ``.onnx``.</span>

<span class="sd">        Args:</span>
<span class="sd">            path: file path, must end on ``.yaml``</span>
<span class="sd">            include_version: add version to class name</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: if file path does not end on ``.yaml``</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">audeer</span><span class="o">.</span><span class="n">path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">audeer</span><span class="o">.</span><span class="n">file_extension</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;yaml&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Model path </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2"> does not end on &#39;.yaml&#39;&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># if model was loaded from a byte stream,</span>
            <span class="c1"># we have to save it first</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">audeer</span><span class="o">.</span><span class="n">replace_file_extension</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;onnx&quot;</span><span class="p">)</span>
            <span class="n">audeer</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
            <span class="n">onnx</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sess</span><span class="o">.</span><span class="n">_model_bytes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">to_yaml</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">include_version</span><span class="o">=</span><span class="n">include_version</span><span class="p">)</span></div></div>


<span class="k">def</span><span class="w"> </span><span class="nf">_concat</span><span class="p">(</span>
    <span class="n">y</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span>
    <span class="n">shapes</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]],</span>
<span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Flatten dictionary by concatenating values.&quot;&quot;&quot;</span>
    <span class="n">y</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

    <span class="c1"># special case if all shapes are [-1]</span>
    <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="nb">map</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="fm">__eq__</span><span class="p">,</span> <span class="n">shapes</span><span class="p">)):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>

    <span class="n">axis</span> <span class="o">=</span> <span class="n">_concat_axis</span><span class="p">(</span><span class="n">shapes</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">axis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;To concatenate outputs &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;number of dimensions, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;position of dynamic axis, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;and all dimensions except the last non-dynamic axis &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;must match. &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;This does not apply to: &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">shapes</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_concat_axis</span><span class="p">(</span><span class="n">shapes</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Return concat dimension or None if not possible.&quot;&quot;&quot;</span>
    <span class="c1"># number of dimensions do not match</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">len</span><span class="p">,</span> <span class="n">shapes</span><span class="p">)))</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># dynamic axis in different positions</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">_dynamic_axis</span><span class="p">,</span> <span class="n">shapes</span><span class="p">)))</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># select last non-dynamic axis</span>
    <span class="n">axis</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">shapes</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="p">(</span><span class="mi">2</span> <span class="k">if</span> <span class="n">shapes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="k">else</span> <span class="mi">1</span><span class="p">)</span>

    <span class="c1"># remove concat axis</span>
    <span class="n">shapes_wo_axis</span> <span class="o">=</span> <span class="p">[</span><span class="n">shape</span><span class="p">[:</span><span class="n">axis</span><span class="p">]</span> <span class="o">+</span> <span class="n">shape</span><span class="p">[</span><span class="n">axis</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:]</span> <span class="k">for</span> <span class="n">shape</span> <span class="ow">in</span> <span class="n">shapes</span><span class="p">]</span>

    <span class="c1"># non-concat dimensions do not match</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">shapes_wo_axis</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="fm">__eq__</span><span class="p">,</span> <span class="n">shapes_wo_axis</span><span class="p">)):</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">axis</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_dynamic_axis</span><span class="p">(</span><span class="n">shape</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Return dimension of dynamic axis or None if none.&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">dim</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">shape</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">dim</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">idx</span>
    <span class="k">return</span> <span class="kc">None</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_last_static_dim_size</span><span class="p">(</span>
    <span class="n">shape</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Return size of last static dimension.&quot;&quot;&quot;</span>
    <span class="n">shape</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="fm">__ne__</span><span class="p">,</span> <span class="n">shape</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_shape</span><span class="p">(</span>
    <span class="n">shape</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span> <span class="o">|</span> <span class="nb">str</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Replace dynamic dimensions with -1.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="k">else</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">shape</span><span class="p">]</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div>
    <p>
        
        
        
          Built with <a href="https://www.sphinx-doc.org">Sphinx</a> on 2025/08/19 using the <a href="https://github.com/audeering/sphinx-audeering-theme/">audEERING theme</a>
        
    </p>
  </div>

  <div role="contentinfo">
    <p>
        
      &copy; 2021-2025 audEERING GmbH
    </p>
  </div> 

</footer>
        </div>
      </div>

    </section>

  </div>
  



  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  

    
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/sphinx_highlight.js"></script>
        <script src="../../../_static/thebelab-helper.js"></script>
        <script src="../../../_static/clipboard.min.js"></script>
        <script src="../../../_static/copybutton.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/@jupyter-widgets/html-manager@^1.0.1/dist/embed-amd.js"></script>
    

  

  <script type="text/javascript" src="../../../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>